{% extends 'LiveVotingBundle::base.html.twig' %}

{% block title %}Result|Event|LiveVoting{% endblock %}

{% block stylesheets %}
  <link rel="stylesheet" href= "{{ asset('bundles/livevoting/css/normalize.css') }}"  />
{% endblock %}

{% block body %}
  <div class="row">
    {% if event.event %}
    <div class="col-xs-12 box">
      <div class="row vertical-align-xs">
        <div class="col-xs-4 col-sm-1 image">
          <img src="{{asset('bundles/livevoting/')}}{{ event.getImage ? event.getWebPath : 'img/assets/slave-event.svg'}}">
        </div>
        <div class="col-xs-8 col-sm-6 col-lg-7 text-wrapper">
          <div class="heading">
            <h2>{{ event.getName }}</h2>
          </div>
          <div class="label">
            <label>Results</label>
          </div>
        </div>
        <div class="clearfix visible-xs"></div>
        <div class="col-xs-12 col-sm-5 col-lg-4 ">        
          <div class="text-right actions">
            <a href="{{ path('event', {'event_id':event.getId}) }}" class="text-center"><i class="fa fa-chevron-circle-left"></i><span>{{ event.getName }}</span></a>
          </div>        
        </div>
      </div>
    </div>
    {% else %}
    <div class="col-xs-12 box light" style="background-image: url({{asset('bundles/livevoting/')}}{{ event.getImage ? event.getWebPath : 'img/assets/master-event.png'}});">
      <div class="row vertical-align-xs">
        <div class="col-xs-4 col-sm-1 image garbage">
          <img src="{{asset('bundles/livevoting/img/assets/box-img.svg')}}">
        </div>
        <div class="col-xs-8 col-sm-6 col-lg-7 text-wrapper">
          <div class="heading">
            <h1>{{ event.getName }}</h1>
          </div>
          <div class="label">
            <label>Results</label>
          </div>
        </div>
        <div class="clearfix visible-xs"></div>
        <div class="col-xs-12 col-sm-5 col-lg-4">
          <div class="text-right actions">
            <a href="{{ path('event', {'event_id':event.getId}) }}" class="text-center"><i class="fa fa-chevron-circle-left"></i><span>{{ event.getName }}</span></a>
          </div>
        </div>
      </div>
    </div>
    {% endif %}
  </div>

  <div class="row">
    <div id="chartContainer" class="col-xs-12 col-sm-10 col-sm-offset-1 col-md-6 col-md-offset-3 live-results"></div>
  </div>  
{% endblock %}

{% block javascripts %}
  <script src="http://code.highcharts.com/highcharts.js"></script>

  <script type="text/javascript">
      var requestData, animation_data, chart;
      var event_id = {{ event.getId }};
      function cmp(v1, v2){
          if(v1.presentationValue<v2.presentationValue)return 1;
          if(v1.presentationValue>v2.presentationValue)return -1;
          return 0;
      }
      function load(){
          $.getJSON('{{ live_results_url }}', function(data){
              if('presentations' in data){
                  var sortMe = [], presentationNames = [], presentationValues = [];//, counter = 0;
                  for(var i in data['presentations']){
                      var pres = {};
                      pres.presentationName = data['presentations'][i]['presentation']['name'];
                      pres.presentationValue = data['presentations'][i]['score']['average'];
                      sortMe.push(pres);
                  }
                  sortMe.sort(cmp);
                  for(var i in sortMe){
                      //if( counter < 3 ){
                          presentationNames.push(sortMe[i].presentationName);
                          presentationValues.push(sortMe[i].presentationValue);
                          //counter++;
                      //}
                  }
                  chart.xAxis[0].update({categories: presentationNames}, true);
                  chart.series[0].setData(presentationValues, true, true, true);
              }
              setTimeout(load, 5000);
          });
      }


      $(document).ready(function(){

          chart = new Highcharts.Chart({
              chart: {
                  renderTo: 'chartContainer',
                  //defaultSeriesType: 'bar',
                  type: 'column',
                  events: {
                      load: function(){
                          setTimeout(load, 1000);
                      }
                  },
                  height: 480,
                  spacingTop: 32,
                  marginTop: 96,
                  spacingBottom: 32,
                  marginBottom: 96,
                  //spacingLeft: 32,
                  //marginLeft: 64,
                  //spacingRight: 16,
                  //marginRight: 32,
                  style: {
                    fontFamily: '"ronnia", sans-serif',
                  }
              },
              plotOptions: {
                  column:{
                      colorByPoint: true
                  }
              },
              colors: ["#6dbc45", "#1678b9", "#404041"],
              title: {
                  text: 'Live results: {{ event.getName }}',
                  style: {
                    "color" : "#404041",
                    "font-weight" : "600",
                    "font-size" : "2em"
                  }
              },
              tooltip: {
                enabled: false
              },
              xAxis: {
                  type: 'String',
                  tickPixelInterval: 5,
                  lineColor: "#ffffff",
                  lineWidth: 1,
                  tickColor: "#ffffff",
                  labels: {
                    // align: "left",
                    padding: 16,
                    style: {
                      "color" : "#404041",
                      "font-size" : "14px",
                      "font-weight" : "400",
                    }
                  }
              },
              yAxis: {
                  minPadding: 0.1,
                  maxPadding: 0.1,
                  tickmarkPlacement: 'on',
                  showFirstLabel: false, 
                  min: 0,
                  max: 5,
                  title: {
                      text: 'Average number of rating score',
                      enabled: false
                  },
                  labels: {
                    enabled: false,
                    style: {
                      "color" : "#404041",
                      "font-size" : "18px",
                      "font-weight" : "600"
                    }
                  },
                  //gridLineColor: "#dddddd"
                  gridLineColor: "#ffffff"
              },
              series: [
                  {
                      showInLegend: false,
                      data:[],
                      dataLabels: {
                          enabled: true,
                          rotation: 0,
                          formatter: function() {
                              return this.y;
                          },
                          inside: true,
                          shadow: false,
                          color: "#ffffff",
                          //verticalAlign: "bottom",
                          style: {
                              fontSize: '20px'
                          }
                      }
                  }]
          });

      });
  </script>
{% endblock %}
